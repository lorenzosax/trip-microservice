<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Dynamic table update</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</head>
<body>
    <h2>
      WebSocket Testing
    </h2>
    <label for="jwt">JWT</label>
    <input type="text" style="width: 480px" id="jwt" placeholder="Insert jwt"/>
    <br><br>
    <button type="button" id="getTicket">Get Ticket</button>
    <input type="text" style="width: 480px" id="ticket" placeholder="Insert Ticket"/>
    <br><br>
	<button type="button" id="connect">Connect</button>
	<button type="button" id="sendMsg" disabled>Send TripReq</button>
    <div id="table-container">
        <table id = "table" border= "1">
            <tr>
                <th> TripId </th>
                <th> VehicleId </th>
                <th> PickUpNodeId </th>
           </tr>
        </table>
    </div>
    <div id="console">
    </div>
	
	
	<script type="application/javascript">
        $( document ).ready(function() {
            var Table = {};

            Table.write = function (data) {
                var table = document.getElementById('table');
                var row = document.createElement('tr');
                row.appendChild(document.createElement('td'));
                row.appendChild(document.createElement('td'));
                row.appendChild(document.createElement('td'));
                row.cells[0].innerHTML = data.tripId;
                row.cells[1].innerHTML = data.vehicleId;
                row.cells[2].innerHTML = data.pickUpNodeId;
                table.appendChild(row);
            };

            var Console = {};

            Console.write = function (message) {
                var console = document.getElementById('console');
                var p = document.createElement('p');
                p.innerHTML = message;
                console.appendChild(p);
            };

            var Channel = {};

            Channel.socket = null;


            Channel.connect = function (host) {
                Channel.socket = new WebSocket(host);
                Channel.socket.onopen = function () {
                    document.getElementById("sendMsg").disabled = false;
                    Console.write("Connection open");
                };

                Channel.socket.onclose = function () {
                    Console.write("Connection close");
                };

                Channel.socket.onmessage = function (message) {
                    let data = JSON.parse(message.data);
                    if (data.tripId)
                        Table.write(data);
                    else
                        Console.write(data.status);
                };
            };

            document.getElementById("connect").onclick = function () {
                let ticket = document.getElementById("ticket").value;
                Channel.connect('ws://127.0.0.1:8080/api/city/notifications?ticket=' + ticket);
                document.getElementById("connect").disabled = true;
            };

            document.getElementById("sendMsg").onclick = function () {
                var objToSend = {
                    osmidSource: 500,
                    osmidDestination: 30
                };
                Channel.socket.send(JSON.stringify(objToSend));
                document.getElementById("connect").disabled = true;
            };

            document.getElementById("getTicket").onclick = function () {

                document.getElementById("connect").disabled = false;
                $.ajax({
                    crossOrigin: true,
                    type: "GET",
                    headers: {
                        "Authorization": "Bearer " + document.getElementById("jwt").value
                    },
                    url: "http://localhost:8080/api/city/tickets",
                    dataType: "jsonp",
                    success: function (data) {
                        document.getElementById("ticket").value = data.oneTimeTicket;
                    },
                    error: function (jqxhr, exception) {
                        alert("Error calling REST API");
                    }
                });
            };
        });

    </script>
</body>
</html>
